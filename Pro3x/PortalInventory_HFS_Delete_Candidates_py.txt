import pandas as pd
#from IPython.display import display

import arcgis
from arcgis.gis import GIS

# FROM: https://developers.arcgis.com/python/samples/inventory-organizational-content/

#Portal URL - *****EDIT*****
url = 'https://<portal fully qualified hostname>:7443/arcgis'

#Built in PSA - *****EDIT*****
username = '<portal admin user>'
password = '<portal admin password>'

#Max users returned by Portal user searvh (set higher than portal user count)
max_users = 5000

#Portal object
gis = GIS(url,username,password)

#Get users
org_users = gis.users.search(max_users=max_users, exclude_system=True)
print(f"{len(org_users)} users found")

#Get content
org_content = []
for user in org_users:
    qe = f"owner: {user.username}"
    user_content = gis.content.advanced_search(query=qe, max_items=-1)['results']
    org_content += user_content

content_df = pd.DataFrame(org_content)

#Item count by type
print(content_df.type.value_counts().head(10))

#Filter columns
view_columns = ['id', 'title', 'owner', 'ownerFolder', 'type', 'access', 'created', 'modified', 'numViews', 'numRatings', 'avgRating', 'numComments', 'groupDesignations', 'url', 'typeKeywords']

#Get hosted feature service items that have not been viewed more than 5 times. Return subset of columns.  These are candidates for delet
type_filter = content_df.typeKeywords.str.contains('Hosted Service',regex=False)
web_map_filter = content_df.numViews < 5
combined_mask = web_map_filter & type_filter

#print(content_df[combined_mask][view_columns].head(20))

#Output CSV - *****EDIT*****
target_path = "c:\\temp\\org_content_HFS_Delete_Candidates.csv"
content_df[combined_mask][view_columns].to_csv(target_path)

#Export to CSV
#View CSV considerations: convert date in Excel using =DATE(1970,1,1+I2/86400000)
#                         Consider ordering by the following fields when reviewing content to be marked for deletion: owner, access, numViews,modified, created
#                         Note that hosted services are identified by the typeKeyword 'Hosted Service'


    


